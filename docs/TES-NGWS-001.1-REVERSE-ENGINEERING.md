# TES-NGWS-001.1: NowGoal JWT Acquisition Reverse-Engineering

## Overview

This document captures the reverse-engineered process for acquiring JWT tokens from NowGoal's authentication system. This is the foundation for TES-NGWS-001, enabling the "Transcendent Edge Sentinel" to connect to NowGoal's WebSocket feed.

## Status

**Phase:** ✅ Reverse-Engineering Complete (Legacy) | ⚠️ 2025 Endpoint Refactor Detected  
**Date Started:** 2024-12-19  
**Date Completed:** 2024-12-19  
**2025 Status Update:** 2025-11-11 - Endpoint returning dashes instead of tokens  
**Status:** ✅ Complete (Legacy) | ⚠️ Requires Alternative (2025)

---

## Reverse-Engineered Details

### Authentication Endpoint

#### Endpoint URL
```
GET https://live.nowgoal26.com/ajax/getwebsockettoken?rnum=<random>
```

**Notes:**
- Uses `live.nowgoal26.com` subdomain (not main domain)
- Requires random `rnum` query parameter for anti-caching
- No authentication credentials required (public endpoint)

#### HTTP Method
```
GET
```

#### Request Headers
```http
Origin: https://live.nowgoal26.com
Referer: https://live.nowgoal26.com/basketball
User-Agent: TES-NowGoal-Client/1.0
Accept: */*
```

**Notes:**
- `Origin` and `Referer` headers required for CORS
- `User-Agent` can be customized
- No authentication headers needed

#### Query Parameters
```
rnum=<random_number>
```

**Example:**
```
?rnum=0.1234567890123456
```

**Purpose:** Anti-caching mechanism - random number prevents cached responses

#### Request Body/Payload
```
None (GET request)
```

### Response Details

#### Response Status
```
200 OK
```

#### Response Headers
```http
Content-Type: text/plain
```

**Notes:**
- Simple text/plain response
- No Set-Cookie headers
- No special authentication headers

#### Response Body
```
<JWT_TOKEN_STRING>
```

**Format:** Plain text JWT token (entire response body is the token)

**Example:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyNDI2MjJ9.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

#### JWT Token Location
- ✅ **Body:** Entire response body contains the JWT token as plain text
- Token is NOT in cookies
- Token is NOT in headers
- Token is NOT in JSON response

### JWT Token Analysis

#### Token Structure
```
<header>.<payload>.<signature>
```

Standard JWT format with three base64url-encoded parts separated by dots.

#### Decoded Payload (Example)
```json
{
  "sub": "user123",
  "iat": 1516239022,
  "exp": 1516242622
}
```

**Key Claims:**
- `exp`: Expiration timestamp (Unix epoch seconds)
- `iat`: Issued at timestamp
- `sub`: Subject (user identifier)

#### Token Expiration
```
~60 seconds
```

**Notes:**
- Token expires very quickly (~60 seconds)
- Must refresh frequently
- Expiration extracted from JWT `exp` claim
- Refresh threshold: 300 seconds (5 minutes) before expiration

### WebSocket Connection Requirements

#### WebSocket URL
```
wss://live.nowgoal26.com/ws
```

**Notes:**
- Uses `wss://` (secure WebSocket)
- Same subdomain as auth endpoint (`live.nowgoal26.com`)

#### Authentication Method
- ✅ **JWT in WebSocket handshake header**

#### Required Headers for WebSocket Upgrade
```http
Authorization: Bearer <JWT_TOKEN>
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: <base64_key>
Sec-WebSocket-Version: 13
```

**Key Points:**
- JWT token passed in `Authorization: Bearer` header
- Standard WebSocket upgrade headers required
- `Sec-WebSocket-Key` generated by client

---

## Implementation Details

### Code Location
- **File:** `src/lib/nowgoal-jwt-acquisition.ts`
- **Function:** `getFreshJwtToken()`
- **Config:** `DEFAULT_NOWGOAL_JWT_CONFIG`

### Configuration Object
```typescript
const DEFAULT_NOWGOAL_JWT_CONFIG: NowGoalJwtConfig = {
  authEndpoint: '/ajax/getwebsockettoken',
  method: 'GET',
  headers: {
    'Origin': 'https://live.nowgoal26.com',
    'Referer': 'https://live.nowgoal26.com/basketball',
    'User-Agent': 'TES-NowGoal-Client/1.0',
    'Accept': '*/*',
  },
  queryParams: {
    // rnum added dynamically with random number
  },
  tokenLocation: 'body',
  tokenFieldName: '',
  tokenExpiration: 60,
};
```

### Token Acquisition Flow

1. **Generate random number** for `rnum` parameter
2. **Build URL** with query parameter: `?rnum=<random>`
3. **Make GET request** to `https://live.nowgoal26.com/ajax/getwebsockettoken?rnum=<random>`
4. **Extract token** from response body (plain text)
5. **Decode JWT** to extract expiration time
6. **Return token** with expiration metadata

### Token Refresh Logic

- **Refresh threshold:** 300 seconds (5 minutes) before expiration
- **Automatic refresh:** `refreshJwtTokenIfNeeded()` function
- **Error handling:** Comprehensive error logging with rg metadata

---

## Standardized Header Format for rg Metadata

### RG-Compatible Header String Format

**Format:**
```
HeaderName:HeaderValue~[SCOPE][domain][HEADER_TYPE][META_PURPOSE][VERSION][TICKET][BUN_API][#REF:url][TIMESTAMP:timestamp]
```

### Example Headers

#### Origin Header (Request)
```
Origin:https://live.nowgoal26.com~[REQUEST][live.nowgoal26.com][CLIENT_INFO][JWT_ACQUIRE][HTTP/1.1][TES-NGWS-001.1][Bun.fetch][#REF:https://live.nowgoal26.com/ajax/getwebsockettoken][TIMESTAMP:1734567890123]
```

#### Authorization Header (WebSocket)
```
Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...~[WEBSOCKET][live.nowgoal26.com][SECURITY][WS_UPGRADE][WS/13][TES-NGWS-001.1][Bun.WebSocket][#REF:wss://live.nowgoal26.com/ws][TIMESTAMP:1734567890123]
```

### Header Metadata Dimensions

1. **SCOPE**: `AUTH` | `STREAM` | `REQUEST` | `RESPONSE` | `WEBSOCKET` | `NETWORK_CONTROL`
2. **domain**: `live.nowgoal26.com` (NowGoal domain)
3. **HEADER_TYPE**: `SECURITY` | `CLIENT_INFO` | `NETWORK_CONTROL` | `API_METADATA` | `CORS` | `CACHE` | `CONTENT`
4. **META_PURPOSE**: `JWT_ACQUIRE` | `JWT_SET` | `JWT_REFRESH` | `SESSION_MANAGE` | `API_RESPONSE` | `WS_UPGRADE`
5. **VERSION**: `HTTP/1.1` | `HTTP/2` | `WS/13`
6. **TICKET**: `TES-NGWS-001.1` (ticket identifier)
7. **BUN_API**: `Bun.fetch` | `Bun.Cookie` | `Bun.WebSocket` | `Bun.CookieMap`
8. **#REF**: URL reference (endpoint URL or documentation)
9. **TIMESTAMP**: Unix timestamp in milliseconds

---

## Security Considerations

1. **No Credentials Required**: Endpoint is public, no authentication needed
2. **Token Storage**: Store JWT tokens securely, never in logs or client-side storage
3. **Token Refresh**: Implement automatic token refresh before expiration (5-minute threshold)
4. **Error Handling**: Handle authentication failures gracefully without exposing sensitive information
5. **Rate Limiting**: Unknown - monitor for rate limit responses

### Error Scenarios

1. **Invalid Request**: 400 Bad Request
2. **Server Error**: 500 Internal Server Error
3. **Network Error**: Connection timeout/failure
4. **Expired Token**: Token expires after ~60 seconds (handled by refresh logic)

### Rate Limiting

**Status:** Unknown - no rate limiting observed during reverse-engineering

---

## Verification

### Test Command
```bash
# Test JWT acquisition
curl "https://live.nowgoal26.com/ajax/getwebsockettoken?rnum=$(python3 -c 'import random; print(random.random())')" \
  -H "Origin: https://live.nowgoal26.com" \
  -H "Referer: https://live.nowgoal26.com/basketball"
```

### Expected Response
```
<JWT_TOKEN_STRING>
```

### RG Query Examples

```bash
# Find all JWT acquisition attempts
rg "JWT_ACQUIRE" logs/headers-index.log

# Find all NowGoal authentication headers
rg "\[live.nowgoal26.com\].*\[AUTH\]" logs/headers-index.log

# Find failed JWT acquisitions
rg "JWT_ACQUIRE_FAILURE" logs/headers-index.log

# Find successful JWT acquisitions
rg "JWT_ACQUIRE_SUCCESS" logs/headers-index.log
```

---

## Implementation Status

- ✅ **Reverse-Engineering:** Complete
- ✅ **JWT Acquisition:** Implemented (`getFreshJwtToken()`)
- ✅ **Token Refresh:** Implemented (`refreshJwtTokenIfNeeded()`)
- ✅ **RG Logging:** Fully integrated
- ✅ **Error Handling:** Comprehensive
- ✅ **WebSocket Integration:** Complete

---

## References

- [Bun.fetch() Documentation](https://bun.sh/docs/api/fetch)
- [Bun.WebSocket Documentation](https://bun.sh/docs/api/websocket)
- [JWT.io](https://jwt.io/) - JWT token decoder
- [RFC 7519 - JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519)

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2024-12-19 | Initial reverse-engineering | TES Team |
| 2025-11-11 | Documentation updated with actual values | TES Team |
