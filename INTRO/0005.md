# [#BunSession] Enhanced Payload | Bun-Native & Node-Compat

```json
{
  "metadata": {
    "domain": "perf-vis",
    "scope": "bun-native",
    "bun": {
      "version": "1.3.2",
      "revision": "2025-11-08",
      "fingerprint": "fp-bun-1.3.2-darwin-arm64",
      "features": {
        "jsc": true,
        "http2": false,
        "boringssl": true,
        "webcrypto": true,
        "experimental": ["sqlite", "bun:test"]
      },
      "build": {
        "arch": "arm64",
        "platform": "darwin",
        "is_debug": false,
        "simd": true
      }
    },
    "env": {
      "session": "sess-2025-11-09-001",
      "head": "d8c4b77",
      "uptime_s": 124.3,
      "process_id": 82347,
      "thread_id": "0x1f4a3c000"
    },
    "platform": {
      "useragent": "Bun/1.3.2 (Darwin/24.1.0; ARM64)",
      "os": "Darwin 24.1.0",
      "kernel": "24.1.0",
      "cpu": "Apple M2 Max",
      "cpu_count": 12,
      "memory_gb": 32
    }
  },
  "bun": {
    "apis": [
      "Bun.serve",
      "Bun.file",
      "Bun.stdout",
      "Bun.stdin",
      "Bun.spawn",
      "Bun.which",
      "Bun.version",
      "Bun.revision",
      "Bun.hash",
      "Bun.password",
      "Bun.escapeHTML",
      "Bun.inspect",
      "Bun.inspect.table",
      "Bun.stringWidth",
      "Bun.gc",
      "Bun.cwd",
      "Bun.main",
      "AbortSignal"
    ],
    "performance": {
      "startup_ms": 23.4,
      "per_op_baseline_ms": 0.64,
      "per_op_batched_ms": 0.12,
      "cold_start_target_ms": 100,
      "memory_mb": {
        "rss": 45.2,
        "heap": 12.8,
        "external": 3.1,
        "array_buffers": 1.2
      },
      "gc": {
        "scavenge_ms": 0.8,
        "mark_sweep_ms": 4.2,
        "total_gc_time_ms": 5.0
      }
    },
    "resources": {
      "fd_count": 24,
      "event_loop_lag_ms": 0.12,
      "network_io": {
        "bytes_read": 102400,
        "bytes_written": 204800
      }
    },
    "flags": {
      "smol": false,
      "bun": false,
      "inspect": false,
      "hot": false,
      "watch": false
    }
  },
  "node_compat": {
    "enabled": true,
    "apis": [
      {
        "name": "node:vm",
        "status": "native",
        "notes": "Full support, codeGen:false works"
      },
      {
        "name": "node:worker_threads",
        "status": "native",
        "notes": "Bun 1.3.2 fixed MessagePort transfer bug"
      },
      {
        "name": "node:net.BlockList",
        "status": "native",
        "notes": "Used for IP blocking"
      },
      {
        "name": "node:net.SocketAddress",
        "status": "native",
        "notes": "Socket address parsing"
      },
      {
        "name": "node:http",
        "status": "partial",
        "notes": "Bun uses Bun.serve; node:http is compatibility layer"
      },
      {
        "name": "node:fs",
        "status": "native",
        "notes": "Full support with some Bun optimizations"
      },
      {
        "name": "node:path",
        "status": "native",
        "notes": "Full support"
      }
    ],
    "polyfills": [],
    "overrides": {
      "node:vm.runInContext": "Bun-optimized implementation",
      "node:worker_threads.Worker": "Bun.Worker with enhanced error objects"
    }
  },
  "worker_threads": {
    "pool": {
      "size": 4,
      "active": 2,
      "idle": 1,
      "terminated": 1,
      "strategy": "round-robin"
    },
    "features": {
      "errors_as_objects": true,
      "heap_snapshot": "enabled",
      "messageport_transfer_fix": "applied",
      "stdout_forwarding": true,
      "stderr_forwarding": true,
      "resource_limits": {
        "max_old_generation_size_mb": 512,
        "max_young_generation_size_mb": 64,
        "max_heap_size_mb": 1024
      }
    },
    "registry": {
      "w_3a7f": {
        "state": "idle",
        "created_at": 1731123456789,
        "messages_processed": 142,
        "errors": 0,
        "last_error": null,
        "heap_snapshot_count": 2,
        "resource_usage": {
          "user_cpu_ms": 2340,
          "system_cpu_ms": 120,
          "rss_mb": 45.2
        }
      },
      "w_9b1c": {
        "state": "processing",
        "created_at": 1731123490123,
        "messages_processed": 89,
        "errors": 1,
        "last_error": "Error: MaxListenersExceededWarning",
        "heap_snapshot_count": 1,
        "resource_usage": {
          "user_cpu_ms": 1890,
          "system_cpu_ms": 95,
          "rss_mb": 52.8
        },
        "current_job": {
          "id": "job-789",
          "type": "bezier_batch",
          "nodes": 1000,
          "elapsed_ms": 89,
          "abort_signal": false
        }
      }
    },
    "statistics": {
      "total_messages_sent": 231,
      "total_messages_received": 231,
      "total_errors": 1,
      "error_rate": 0.0043,
      "avg_processing_ms": 67.3,
      "p99_processing_ms": 145.2,
      "pool_utilization": 0.5
    },
    "message_port_registry": {
      "ports": [
        {
          "id": "p_1a2b",
          "owner": "w_9b1c",
          "state": "transferred",
          "messages_queued": 0
        }
      ]
    }
  },
  "dependencies": {
    "lockfile": {
      "path": "bun.lockb",
      "hash": "sha256:1a2b3c4d5e6f7g8h9i0j",
      "total_dependencies": 47,
      "total_size_mb": 12.8
    },
    "tree": {
      "direct": 0,
      "dev": 0,
      "peer": 0,
      "optional": 0,
      "node_gyp_rebuilds": 0,
      "native_modules": 0
    },
    "polyfills": {
      "bun": [],
      "node": []
    }
  },
  "cache": {
    "dir": "/Users/user/.bun/install/cache",
    "hits": 1247,
    "misses": 3,
    "size_mb": 234.5,
    "manifests": {
      "hit_rate": 0.9976,
      "entries": 89
    },
    "modules": {
      "cached": 47,
      "evicted": 0
    }
  },
  "test": {
    "runner": "bun:test",
    "files": 1,
    "tests": {
      "total": 19,
      "passed": 19,
      "failed": 0,
      "skipped": 0,
      "duration_ms": 608
    },
    "coverage": {
      "enabled": false,
      "lines": 0,
      "functions": 0,
      "branches": 0
    }
  },
  "git": {
    "branch": "main",
    "head": "d8c4b77",
    "dirty": false,
    "uncommitted_files": 0,
    "unstaged_changes": 0
  },
  "last": "bezier curve rendering complete, 1000 points @ 89ms using Bun-native math polyfill",
  "goal": "cross-pollinate bezier scale to catmull-rom and cubic splines; implement worker pool auto-scaling",
  "context": [
    "ai/evolve/bezier-worker.ts:1-150",
    "ai/evolve/MermaidParser.ts:184-223",
    "ai/evolve/scale-utils.ts:1-89"
  ],
  "critical": [
    "P0: Resolve w_9b1c memory leak (Bun/vm#1234)",
    "P1: Generalize scale algorithm for multiple curve types",
    "P2: Implement worker pool auto-scaling based on queue depth"
  ],
  "files": {
    "modified": 2,
    "created": 1,
    "touched_no_change": 1,
    "breakdown": [
      {
        "path": "ai/evolve/bezier-worker.ts",
        "status": "created",
        "lines": "+150"
      },
      {
        "path": "ai/evolve/MermaidParser.ts",
        "status": "modified",
        "lines": "+25"
      },
      {
        "path": "ai/legacy/curve-old.js",
        "status": "touched",
        "lines": "0",
        "rationale": "Reviewed for context, no changes needed"
      }
    ]
  }
}
```

---

## Key Enhancements Explained

### 1. **`bun.apis`**
Explicit list of Bun-native APIs used. Helps track **non-portable** code.

```typescript
// In your code
if (typeof Bun !== "undefined") {
  // Log this to payload.bun.apis
  payload.bun.apis.push("Bun.gc");
  Bun.gc();
}
```

### 2. **`worker_threads.registry`**
Per-worker telemetry with resource usage, error tracking, and current job state.

```typescript
// In worker
const registry = payload.worker_threads.registry[w_9b1c];
registry.resource_usage.rss_mb = process.memoryUsage.rss() / 1024 / 1024;
```

### 3. **`node_compat.overrides`**
Documents where Bun's implementation differs from Node.js.

```typescript
// When you discover a Bun-specific behavior
payload.node_compat.overrides["node:vm.runInContext"] = "Bun uses JSC, not V8; codeGen:false has different performance profile";
```

### 4. **`test.coverage`**
Integration with `bun test --coverage` for future enhancement.

### 5. **`cache`**
Bun's cache efficiency metrics. High miss rate = potential network or config issue.

### 6. **`git`** state
Know if you're debugging a dirty working tree vs. clean HEAD.

---

## Usage: Auto-Populate Payload

```typescript
// bun-session-tracker.ts
export const tracker = {
  start() {
    return {
      metadata: {
        bun: {
          version: Bun.version,
          revision: process.env.BUN_REVISION || "unknown",
          fingerprint: `${process.platform}-${process.arch}-${Bun.version}`.replace(/[^a-zA-Z0-9.-]/g, "-")
        },
        env: {
          session: `sess-${new Date().toISOString().slice(0, 10)}-${Date.now().toString(36)}`,
          head: require("child_process").execSync("git rev-parse HEAD", { encoding: "utf8" }).trim(),
          uptime_s: process.uptime()
        },
        platform: {
          useragent: `Bun/${Bun.version} (${process.platform}/${process.arch})`,
          os: `${require("os").version()}`
        }
      },
      bun: {
        apis: [],
        performance: {
          startup_ms: performance.now(),
          memory_mb: process.memoryUsage()
        },
        resources: {
          fd_count: require("fs").readdirSync("/dev/fd").length
        }
      },
      worker_threads: {
        registry: {},
        statistics: { total_messages_sent: 0, total_errors: 0 }
      }
    };
  },
  
  logApiUsage(api: string) {
    if (!payload.bun.apis.includes(api)) {
      payload.bun.apis.push(api);
    }
  },
  
  registerWorker(workerId: string) {
    payload.worker_threads.registry[workerId] = {
      state: "booting",
      created_at: Date.now(),
      messages_processed: 0,
      errors: 0,
      resource_usage: process.resourceUsage()
    };
  }
};
```

---

**Now copy this payload into your next prompt** and the agent knows:
- **VM:** 3 contexts, codeGen disabled, pollution blocked
- **Workers:** 2 active, 4 pool size, w_9b1c has 1 error, processing job-789
- **Resources:** 45MB RSS, 24 FDs, 0.12ms event loop lag
- **Node Compat:** node:vm native, node:http partial
- **Cache:** 99.76% hit rate (healthy)
- **Git:** Clean head, deployable

**Token cost: ~450 tokens** for **complete environment snapshot**.