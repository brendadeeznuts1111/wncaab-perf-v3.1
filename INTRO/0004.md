# [#BunSession] Ultra-Detailed Payload | Bun-Native & Node-Compat

```json
{
  "metadata": {
    "domain": "perf-vis",
    "scope": "bun-native",
    "bun": {
      "version": "1.3.2",
      "revision": "2025-11-08",
      "fingerprint": "fp-bun-1.3.2-darwin-arm64",
      "build": {
        "arch": "arm64",
        "platform": "darwin",
        "is_debug": false,
        "simd": true,
        "mimalloc": true,
        "tls_library": "boringssl",
        "version_hash": "1a2b3c4d5e",
        "built_at": "2025-11-08T14:23:45Z"
      },
      "features": {
        "jsc": "JavaScriptCore 2025-11-08",
        "webgl": true,
        "http2": false,
        "websocket": true,
        "boringssl": true,
        "webcrypto": "WebCryptoAPI Level 4",
        "experimental": ["sqlite", "bun:test", "http-streaming"],
        "disabled": ["node:http2"]
      },
      "env": {
        "session": "sess-2025-11-09-001",
        "head": "d8c4b77",
        "uptime_s": 124.3,
        "process_id": 82347,
        "thread_id": "0x1f4a3c000",
        "node_env": "development",
        "bun_env": {
          "dev": true,
          "prod": false,
          "test": false
        }
      },
      "platform": {
        "useragent": "Bun/1.3.2 (Darwin/24.1.0; ARM64)",
        "os": "Darwin 24.1.0",
        "kernel": "24.1.0",
        "cpu": "Apple M2 Max",
        "cpu_count": 12,
        "cpu_model": "Apple M2 Max",
        "memory_gb": 32,
        "memory_free_gb": 8.4,
        "swap_total_gb": 8.0,
        "swap_used_gb": 0.2,
        "hostname": "macbook-pro.local",
        "user": "developer"
      }
    }
  },
  "bun": {
    "native_apis": {
      "builtins": [
        {
          "name": "Bun.serve",
          "status": "used",
          "calls": 1,
          "perf_ms": { "avg": 23.4, "p99": 45.2 }
        },
        {
          "name": "Bun.file",
          "status": "used",
          "calls": 142,
          "perf_ms": { "avg": 0.12, "p99": 0.45 }
        },
        {
          "name": "Bun.stdout",
          "status": "used",
          "calls": 0,
          "perf_ms": { "avg": 0, "p99": 0 }
        },
        {
          "name": "Bun.spawn",
          "status": "unused"
        },
        {
          "name": "Bun.which",
          "status": "unused"
        },
        {
          "name": "Bun.hash",
          "status": "used",
          "calls": 89,
          "perf_ms": { "avg": 0.08, "p99": 0.23 }
        },
        {
          "name": "Bun.password",
          "status": "unused"
        },
        {
          "name": "Bun.escapeHTML",
          "status": "used",
          "calls": 1000,
          "perf_ms": { "avg": 0.02, "p99": 0.05 }
        },
        {
          "name": "Bun.inspect",
          "status": "used",
          "calls": 15,
          "perf_ms": { "avg": 1.2, "p99": 3.4 }
        },
        {
          "name": "Bun.inspect.table",
          "status": "unused"
        },
        {
          "name": "Bun.stringWidth",
          "status": "unused"
        },
        {
          "name": "Bun.gc",
          "status": "used",
          "calls": 5,
          "perf_ms": { "avg": 5.0, "p99": 8.2 }
        },
        {
          "name": "Bun.main",
          "status": "used",
          "calls": 1,
          "perf_ms": { "avg": 0, "p99": 0 }
        },
        {
          "name": "Bun.version",
          "status": "used",
          "calls": 3,
          "perf_ms": { "avg": 0, "p99": 0 }
        },
        {
          "name": "Bun.revision",
          "status": "used",
          "calls": 1,
          "perf_ms": { "avg": 0, "p99": 0 }
        },
        {
          "name": "Bun.CryptoHasher",
          "status": "unused"
        },
        {
          "name": "Bun.jest",
          "status": "unused"
        },
        {
          "name": "Bun.semver",
          "status": "unused"
        },
        {
          "name": "Bun.dns",
          "status": "unused"
        },
        {
          "name": "bun:sqlite",
          "status": "unused"
        }
      ],
      "globals": {
        "Bun": true,
        "Deno": false,
        "NodeJS": false,
        "global": true,
        "globalThis": true,
        "__dirname": true,
        "__filename": true,
        "Buffer": true,
        "process": true,
        "console": true,
        "performance": true,
        "AbortController": true,
        "AbortSignal": true,
        "crypto": true,
        "fetch": true,
        "Request": true,
        "Response": true,
        "Headers": true,
        "FormData": true,
        "URL": true,
        "URLSearchParams": true,
        "TextEncoder": true,
        "TextDecoder": true,
        "queueMicrotask": true,
        "setImmediate": true,
        "clearImmediate": true,
        "setInterval": true,
        "clearInterval": true,
        "setTimeout": true,
        "clearTimeout": true
      }
    },
    "stdlib": {
      "builtins": [
        "bun", "bun:test", "bun:sqlite", "bun:jsc", "bun:ffi", "bun:wrap"
      ],
      "loaded": [
        "bun:wrap", "bun:ffi"
      ]
    },
    "performance": {
      "startup_ms": 23.4,
      "per_op_baseline_ms": 0.64,
      "per_op_batched_ms": 0.12,
      "cold_start_target_ms": 100,
      "dependencies_load_ms": 45.2,
      "first_paint_ms": 0,
      "ttfb_ms": 12.8,
      "counters": {
        "total_requests": 1247,
        "total_ops": 231,
        "cache_hits": 1247,
        "cache_misses": 3,
        "gc_runs": 8,
        "worker_spawns": 4,
        "worker_restarts": 1
      },
      "memory_mb": {
        "rss": 45.2,
        "heap_total": 16.8,
        "heap_used": 12.8,
        "external": 3.1,
        "array_buffers": 1.2,
        "detached": 0
      },
      "gc": {
        "scavenge_ms": 0.8,
        "mark_sweep_ms": 4.2,
        "total_gc_time_ms": 5.0,
        "gc_time_percent": 0.04
      },
      "event_loop": {
        "lag_ms": 0.12,
        "utilization": 0.23,
        "handles": 24,
        "requests": 8
      }
    },
    "resources": {
      "fd_count": 24,
      "event_loop_lag_ms": 0.12,
      "network_io": {
        "bytes_read": 102400,
        "bytes_written": 204800,
        "requests": 1247
      },
      "disk_io": {
        "bytes_read": 5242880,
        "bytes_written": 2097152,
        "read_ops": 142,
        "write_ops": 89
      },
      "cpu_usage_percent": 12.3,
      "memory_pressure": "normal"
    },
    "flags": {
      "smol": false,
      "bun": false,
      "inspect": false,
      "hot": false,
      "watch": false,
      "jit": true,
      "trace_gc": false,
      "trace_bun": false,
      "expose_gc": true
    },
    "environment": {
      "NODE_ENV": "development",
      "BUN_ENV": "development",
      "TZ": "UTC",
      "LANG": "en_US.UTF-8",
      "PATH": "/usr/local/bin:/usr/bin:/bin",
      "HOME": "/Users/developer"
    }
  },
  "node_compat": {
    "enabled": true,
    "mode": "native",
    "apis": [
      {
        "name": "node:vm",
        "status": "native",
        "methods": ["runInContext", "createContext", "compileFunction"],
        "notes": "Full support, codeGen:false works, Bun 1.3.2 fixed memory leak",
        "overrides": {
          "runInContext": "JSC implementation, different performance profile than V8"
        }
      },
      {
        "name": "node:worker_threads",
        "status": "native",
        "methods": ["Worker", "parentPort", "workerData", "getHeapSnapshot"],
        "notes": "Bun 1.3.2 fixed MessagePort transfer bug; errors now objects by default",
        "version": "v19.0.0+ features",
        "overrides": {
          "Worker": "Bun.Worker with enhanced error objects and heap snapshot support"
        }
      },
      {
        "name": "node:net",
        "status": "native",
        "methods": ["BlockList", "SocketAddress", "Server", "Socket"],
        "notes": "Full support for BlockList and SocketAddress",
        "overrides": {}
      },
      {
        "name": "node:http",
        "status": "partial",
        "methods": ["Server", "createServer", "request", "response"],
        "notes": "Bun uses Bun.serve; node:http is compatibility layer; no http2",
        "limitations": ["no http2", "no IncomingMessage/outgoingMessage full compat"],
        "overrides": {
          "Server": "Wraps Bun.serve, performance is native"
        }
      },
      {
        "name": "node:fs",
        "status": "native",
        "methods": ["promises", "readFile", "writeFile", "stat"],
        "notes": "Full support with Bun optimizations (faster than Node.js)",
        "overrides": {}
      },
      {
        "name": "node:path",
        "status": "native",
        "methods": ["join", "resolve", "basename", "dirname"],
        "notes": "Full support",
        "overrides": {}
      },
      {
        "name": "node:stream",
        "status": "partial",
        "methods": ["Readable", "Writable", "Transform", "pipeline"],
        "notes": "Bun has native streams; compatibility layer for legacy code",
        "limitations": ["some edge cases in object mode"],
        "overrides": {}
      },
      {
        "name": "node:crypto",
        "status": "native",
        "methods": ["randomBytes", "createHash", "createHmac", "pbkdf2"],
        "notes": "Uses BoringSSL, faster than Node.js OpenSSL in some cases",
        "overrides": {
          "pbkdf2": "Async version uses worker threads automatically"
        }
      },
      {
        "name": "node:dns",
        "status": "partial",
        "methods": ["lookup", "resolve4", "resolve6"],
        "notes": "Basic support; some advanced features missing",
        "limitations": ["no dns.setServers", "no dns.resolveSrv"],
        "overrides": {}
      },
      {
        "name": "node:cluster",
        "status": "emulated",
        "methods": ["fork", "isMaster", "isWorker"],
        "notes": "Emulated on top of worker_threads; not recommended for new code",
        "overrides": {
          "cluster": "Use worker_threads directly for better performance"
        }
      }
    ],
    "polyfills": [],
    "overrides": {
      "node:vm.runInContext": "JSC implementation, different performance profile than V8",
      "node:worker_threads.Worker": "Bun.Worker with enhanced error objects and heap snapshot support",
      "node:http.Server": "Wraps Bun.serve, performance is native",
      "node:crypto.pbkdf2": "Async version uses worker threads automatically"
    },
    "missing_apis": [
      "node:http2",
      "node:diagnostics_channel",
      "node:trace_events",
      "node:inspector",
      "node:perf_hooks"
    ]
  },
  "worker_threads": {
    "pool": {
      "size": 4,
      "active": 2,
      "idle": 1,
      "terminated": 1,
      "strategy": "round-robin",
      "auto_scale": false,
      "min_size": 2,
      "max_size": 8,
      "scale_threshold": {
        "queue_depth": 10,
        "cpu_percent": 80,
        "memory_mb": 512
      }
    },
    "features": {
      "errors_as_objects": true,
      "heap_snapshot": "enabled",
      "messageport_transfer_fix": "applied",
      "stdout_forwarding": true,
      "stderr_forwarding": true,
      "resource_limits": {
        "max_old_generation_size_mb": 512,
        "max_young_generation_size_mb": 64,
        "max_heap_size_mb": 1024,
        "stack_size_mb": 8,
        "max_synchronous_timeout_ms": 0
      },
      "advanced": {
        "track_unmanaged_fds": true,
        "gc_schedule": "idle",
        "jit_enabled": true,
        "simd_enabled": true
      }
    },
    "registry": {
      "w_3a7f": {
        "id": "w_3a7f",
        "state": "idle",
        "created_at": 1731123456789,
        "uptime_ms": 124560,
        "messages_processed": 142,
        "errors": 0,
        "last_error": null,
        "last_error_at": null,
        "heap_snapshot_count": 2,
        "heap_snapshots": ["heap-1.heapsnapshot", "heap-2.heapsnapshot"],
        "resource_usage": {
          "user_cpu_ms": 2340,
          "system_cpu_ms": 120,
          "rss_mb": 45.2,
          "heap_total_mb": 16.8,
          "heap_used_mb": 12.8,
          "external_mb": 3.1,
          "array_buffers_mb": 1.2
        },
        "performance": {
          "avg_processing_ms": 45.2,
          "p99_processing_ms": 89.1,
          "last_job_ms": 23.4
        },
        "port_state": "open",
        "ports_transferred": 0,
        "current_job": null,
        "thread_id": "0x1f4a3c100"
      },
      "w_9b1c": {
        "id": "w_9b1c",
        "state": "processing",
        "created_at": 1731123490123,
        "uptime_ms": 121890,
        "messages_processed": 89,
        "errors": 1,
        "last_error": "MaxListenersExceededWarning",
        "last_error_at": 1731123890123,
        "heap_snapshot_count": 1,
        "heap_snapshots": ["heap-w_9b1c-1.heapsnapshot"],
        "resource_usage": {
          "user_cpu_ms": 1890,
          "system_cpu_ms": 95,
          "rss_mb": 52.8,
          "heap_total_mb": 18.4,
          "heap_used_mb": 14.2,
          "external_mb": 4.1,
          "array_buffers_mb": 2.1
        },
        "performance": {
          "avg_processing_ms": 67.3,
          "p99_processing_ms": 145.2,
          "last_job_ms": 89.0
        },
        "port_state": "transferred",
        "ports_transferred": 1,
        "current_job": {
          "id": "job-789",
          "type": "bezier_batch",
          "nodes": 1000,
          "started_at": 1731124490123,
          "elapsed_ms": 89,
          "abort_signal": false,
          "priority": "normal"
        },
        "thread_id": "0x1f4a3c200"
      }
    },
    "statistics": {
      "total_messages_sent": 231,
      "total_messages_received": 231,
      "total_errors": 1,
      "error_rate": 0.0043,
      "error_breakdown": {
        "MaxListenersExceededWarning": 1,
        "VMError": 0,
        "TimeoutError": 0
      },
      "avg_processing_ms": 54.8,
      "p99_processing_ms": 145.2,
      "p95_processing_ms": 98.4,
      "pool_utilization": 0.5,
      "queue_depth": {
        "current": 2,
        "max": 10,
        "avg": 3.2
      },
      "throughput_per_second": 1.85
    },
    "message_port_registry": {
      "ports": [
        {
          "id": "p_1a2b",
          "owner": "w_9b1c",
          "state": "transferred",
          "messages_queued": 0,
          "transfer_count": 1,
          "last_transfer_at": 1731124490123,
          "buffered_messages": 0
        }
      ]
    },
    "heap_snapshots": {
      "enabled": true,
      "directory": "./tmp/heapsnapshots",
      "snapshots": [
        {
          "worker_id": "w_9b1c",
          "filename": "heap-w_9b1c-1.heapsnapshot",
          "size_mb": 12.4,
          "created_at": 1731124490123
        }
      ],
      "auto_collect": {
        "on_error": true,
        "interval_ms": 300000,
        "max_size_mb": 100,
        "retention_count": 5
      }
    },
    "diagnostics": {
      "unhandled_rejections": 0,
      "uncaught_exceptions": 0,
      "listener_leaks": {
        "max_listeners": 100,
        "warnings": 1,
        "by_worker": {
          "w_9b1c": 1
        }
      },
      "memory_leaks": {
        "suspected": 1,
        "by_worker": {
          "w_9b1c": "MaxListenersExceededWarning indicates event emitter leak"
        }
      },
      "port_leaks": 0
    }
  },
  "dependencies": {
    "runtime": {
      "lockfile": {
        "path": "bun.lockb",
        "hash": "sha256:1a2b3c4d5e6f7g8h9i0j",
        "total_dependencies": 47,
        "total_size_mb": 12.8,
        "integrity": "verified"
      },
      "tree": {
        "direct": 0,
        "dev": 0,
        "peer": 0,
        "optional": 0,
        "node_gyp_rebuilds": 0,
        "native_modules": 0,
        "bun_native": 47
      },
      "bun_version_specific": {
        "v1.3.2": {
          "changed": ["node:vm", "node:worker_threads", "Bun.file"],
          "fixed_bugs": ["vm-memory-leak", "worker-port-transfer"],
          "performance": {
            "vm_startup": "-40%",
            "worker_spawn": "-25%"
          }
        }
      }
    },
    "polyfills": {
      "bun": [],
      "node": [],
      "third_party": []
    }
  },
  "cache": {
    "global": {
      "dir": "/Users/developer/.bun/install/cache",
      "hits": 1247,
      "misses": 3,
      "hit_rate": 0.9976,
      "size_mb": 234.5
    },
    "manifests": {
      "hit_rate": 0.9976,
      "entries": 89,
      "stale": 0,
      "fresh": 89
    },
    "modules": {
      "cached": 47,
      "evicted": 0,
      "loading": 0,
      "ready": 47
    },
    "compile": {
      "dir": "/Users/developer/.bun/compile-cache",
      "hits": 231,
      "misses": 0,
      "size_mb": 45.2
    }
  },
  "test": {
    "runner": "bun:test",
    "files": 1,
    "suites": 3,
    "tests": {
      "total": 19,
      "passed": 19,
      "failed": 0,
      "todo": 0,
      "skipped": 0,
      "duration_ms": 608,
      "avg_per_test_ms": 32.0
    },
    "coverage": {
      "enabled": false,
      "lines": { "total": 0, "covered": 0, "pct": 0 },
      "functions": { "total": 0, "covered": 0, "pct": 0 },
      "branches": { "total": 0, "covered": 0, "pct": 0 }
    },
    "watch_mode": false,
    "is_tty": true,
    "color": true
  },
  "git": {
    "branch": "main",
    "head": "d8c4b77",
    "dirty": false,
    "uncommitted_files": 0,
    "unstaged_changes": 0,
    "remote": "origin/main"
  },
  "runtime": {
    "process": {
      "pid": 82347,
      "ppid": 82340,
      "uid": 501,
      "gid": 20,
      "cwd": "/Users/developer/projects/perf-vis",
      "exec_path": "/Users/developer/.local/bin/bun",
      "argv": ["bun", "test", "bezier.test.ts"],
      "exit_code": null,
      "signal": null
    },
    "system": {
      "load_avg": [2.34, 2.12, 2.08],
      "cpu_percent": 12.3,
      "memory_percent": 45.2,
      "swap_percent": 2.5,
      "uptime_seconds": 124.3
    },
    "security": {
      "sandbox": "none",
      "capabilities": [],
      "is_privileged": false,
      "is_root": false
    }
  },
  "last": "bezier curve rendering complete, 1000 points @ 89ms using Bun-native math polyfill; worker w_9b1c processed 89 batches successfully with 1 MaxListeners warning (non-critical)",
  "goal": "cross-pollinate bezier scale to catmull-rom and cubic splines; implement worker pool auto-scaling based on queue depth; resolve w_9b1c MaxListeners warning before production",
  "context": [
    "ai/evolve/bezier-worker.ts:1-150",
    "ai/evolve/MermaidParser.ts:184-223",
    "ai/evolve/scale-utils.ts:1-89",
    "ai/evolve/worker-pool.ts:1-67"
  ],
  "critical": [
    "P0: Resolve w_9b1c MaxListeners warning (non-critical but must fix before prod)",
    "P0: Resolve w_9b1c memory leak (Bun/vm#1234)",
    "P1: Generalize bezier scale for catmull-rom and cubic splines",
    "P2: Implement worker pool auto-scaling (queue_depth > 10, cpu > 80%)",
    "P3: Add heap snapshot auto-collection on worker errors"
  ],
  "files": {
    "modified": 2,
    "created": 2,
    "touched_no_change": 1,
    "breakdown": [
      {
        "path": "ai/evolve/bezier-worker.ts",
        "status": "created",
        "lines": "+150"
      },
      {
        "path": "ai/evolve/worker-pool.ts",
        "status": "created",
        "lines": "+67"
      },
      {
        "path": "ai/evolve/MermaidParser.ts",
        "status": "modified",
        "lines": "+25"
      },
      {
        "path": "ai/legacy/curve-old.js",
        "status": "touched",
        "lines": "0",
        "rationale": "Reviewed for context; no changes needed"
      }
    ]
  }
}
```

---

## Key Enhancements Breakdown

### 1. **Bun Native APIs Granularity**
```json
"bun.native_apis.builtins": [
  {
    "name": "Bun.serve",
    "status": "used",
    "calls": 1,
    "perf_ms": { "avg": 23.4, "p99": 45.2 }
  }
]
```
- Track usage status (used/unused)
- Call counters
- Performance percentiles
- Helps identify unused APIs and hot paths

### 2. **Worker Deep Telemetry**
```json
"worker_threads.registry.w_9b1c": {
  "messages_processed": 89,
  "errors": 1,
  "last_error": "MaxListenersExceededWarning",
  "current_job": { "id": "job-789", "type": "bezier_batch", "nodes": 1000 },
  "resource_usage": { "rss_mb": 52.8, "heap_used_mb": 14.2 },
  "thread_id": "0x1f4a3c200"
}
```
- Per-worker job tracking
- Resource usage per worker
- Thread ID for system-level debugging
- Job queue state for each worker

### 3. **Node.js Compatibility Matrix**
```json
"node_compat.apis": [
  {
    "name": "node:vm",
    "status": "native",
    "methods": ["runInContext", "createContext"],
    "overrides": { "runInContext": "JSC implementation" },
    "limitations": []
  }
]
```
- Granular method-level tracking
- Notes on Bun-specific behavior
- Limitations list for edge cases
- Override documentation

### 4. **Performance Counters**
```json
"bun.performance.counters": {
  "total_requests": 1247,
  "gc_runs": 8,
  "worker_spawns": 4,
  "worker_restarts": 1
}
```
- Operation-level counters
- Garbage collection frequency
- Worker lifecycle events
- Helps identify GC pressure and worker churn

### 5. **Cache Deep Dive**
```json
"cache.compile": {
  "dir": "/Users/.bun/compile-cache",
  "hits": 231,
  "misses": 0
}
```
- Separate cache for compiled code
- Module cache state (loading/ready)
- Compile cache efficiency
- Eviction tracking

### 6. **Runtime System Metrics**
```json
"runtime.system": {
  "load_avg": [2.34, 2.12, 2.08],
  "cpu_percent": 12.3,
  "memory_percent": 45.2,
  "swap_percent": 2.5
}
```
- System-level resource usage
- Load average tracking
- Swap pressure monitoring
- Helps identify host-level bottlenecks

### 7. **Worker Diagnostics**
```json
"worker_threads.diagnostics": {
  "listener_leaks": { "warnings": 1, "by_worker": { "w_9b1c": 1 } },
  "memory_leaks": { "suspected": 1, "by_worker": { "w_9b1c": "MaxListeners warning" } },
  "unhandled_rejections": 0,
  "uncaught_exceptions": 0
}
```
- Event listener leak detection
- Memory leak suspicion tracking
- Per-worker diagnostic info
- Helps catch resource leaks early

### 8. **Bun Version-Specific Changes**
```json
"dependencies.bun_version_specific.v1.3.2": {
  "changed": ["node:vm", "node:worker_threads"],
  "fixed_bugs": ["vm-memory-leak", "worker-port-transfer"],
  "performance": { "vm_startup": "-40%", "worker_spawn": "-25%" }
}
```
- Track version-specific behavior
- Document bug fixes by version
- Performance improvements per version
- Critical for debugging version-dependent issues

---

## Usage: Auto-Populate Script

```typescript
// bun-session-tracker.ts
import { writeFileSync } from "fs";

export class BunSessionTracker {
  static collect(): typeof payload {
    const payload = {
      metadata: { /* ... */ },
      bun: {
        native_apis: {
          builtins: this.trackBunApis(),
          globals: this.detectGlobals()
        },
        performance: this.collectPerfMetrics(),
        flags: this.detectFlags()
      },
      worker_threads: this.collectWorkerMetrics(),
      node_compat: this.checkNodeCompat(),
      cache: this.collectCacheStats(),
      test: this.collectTestResults(),
      git: this.collectGitState(),
      runtime: this.collectRuntimeInfo(),
      last: this.getLastState(),
      goal: this.getNextGoal(),
      context: this.getContextFiles(),
      critical: this.getCriticalTasks()
    };
    
    writeFileSync(".claude/session-payload.json", JSON.stringify(payload, null, 2));
    return payload;
  }

  private static trackBunApis() {
    const apis = [
      "Bun.serve", "Bun.file", "Bun.spawn", "Bun.which",
      "Bun.hash", "Bun.password", "Bun.escapeHTML", "Bun.inspect",
      "Bun.gc", "Bun.main", "Bun.version", "Bun.revision"
    ];
    
    return apis.map(name => ({
      name,
      status: this.isApiUsed(name) ? "used" : "unused",
      calls: this.getCallCount(name),
      perf_ms: this.getPerfMetrics(name)
    }));
  }

  private static collectWorkerMetrics() {
    return {
      pool: this.getPoolStats(),
      registry: this.getWorkerRegistry(),
      statistics: this.getWorkerStats(),
      diagnostics: this.getDiagnostics()
    };
  }

  private static detectFlags() {
    return {
      smol: process.env.BUN_JSC_heapSize > 0,
      bun: process.argv.includes("--bun"),
      inspect: !!process.env.BUN_INSPECT,
      hot: !!process.env.BUN_HOT_RELOAD,
      jit: !process.env.BUN_JIT_DISABLE
    };
  }

  private static collectPerfMetrics() {
    return {
      startup_ms: performance.now(),
      counters: {
        total_requests: this.getRequestCount(),
        gc_runs: this.getGcCount(),
        worker_spawns: this.getWorkerSpawnCount()
      },
      memory_mb: process.memoryUsage(),
      gc: this.getGcMetrics(),
      event_loop: this.getEventLoopMetrics()
    };
  }
}

// Usage
BunSessionTracker.collect();
```

---

## Copy-Paste Continuity

**Token count: ~650 tokens** for **complete environment, runtime, worker, and compatibility snapshot**.

**Next session starter:**
```json
{"metadata":{"domain":"perf-vis","scope":"bun-native","bun":{"v":"1.3.2","rev":"2025-11-08","fp":"fp-bun-1.3.2-darwin-arm64"},"env":{"sess":"sess-2025-11-09-001","head":"d8c4b77","up_s":124.3},"plat":{"ua":"Bun/1.3.2 (Darwin/24.1.0; ARM64)","os":"Darwin 24.1.0"}},"bun":{"apis":{"builtins":[{"name":"Bun.serve","calls":1},{"name":"Bun.file","calls":142},{"name":"Bun.hash","calls":89}],"globals":{"Bun":true,"AbortSignal":true}},"perf":{"startup_ms":23.4,"per_node_ms":0.12,"memory_mb":{"rss":45.2,"heap":12.8}}},"wt":{"pool":{"sz":4,"act":2},"feat":{"err_obj":true,"heap_snap":"en","port_fix":"app"},"reg":{"w_3a7f":{"state":"idle","msgs":142,"errs":0},"w_9b1c":{"state":"proc","msgs":89,"errs":1}}}},"last":"bezier done","goal":"cross-poll scales","ctx":["ai-evolve:1-25"],"crit":["P0 mem","P1 gen"],"files":{"mod":2,"cre":1,"touch":1}}
```

**Compressed: ~320 tokens** for mobile prompts.